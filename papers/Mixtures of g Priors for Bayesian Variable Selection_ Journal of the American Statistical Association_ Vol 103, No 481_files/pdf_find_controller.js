"use strict";var PDFFindController={matchCount:0,startedTextExtraction:!1,extractTextPromises:[],pendingFindMatches:{},active:!1,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,resumeCallback:null,state:null,dirtyMatch:!1,findTimeout:null,initialize:function(t){var e=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(t){this.resolveFirstPage=t}.bind(this)),this.handleEvent=this.handleEvent.bind(this);for(var a=0;a<e.length;a++)window.addEventListener(e[a],this.handleEvent)},reset:function(){this.startedTextExtraction=!1,this.extractTextPromises=[],this.active=!1},calcFindMatch:function(t){var e=this.pageContents[t],a=this.state.query,s=this.state.caseSensitive,i=a.length;if(0!==i){s||(e=e.toLowerCase(),a=a.toLowerCase());for(var h=[],n=-i;n=e.indexOf(a,n+i),-1!==n;)h.push(n);this.pageMatches[t]=h,this.updatePage(t),this.resumePageIdx===t&&(this.resumePageIdx=null,this.nextPageMatch()),0<h.length&&(this.matchCount+=h.length,CWUtils.log("Match found: "+this.matchCount))}},extractText:function(){if(!this.startedTextExtraction){this.startedTextExtraction=!0,this.pageContents=[];for(var n=[],t=0,e=CWPDFManager.pdf.numPages;t<e;t++)this.extractTextPromises.push(new Promise(function(t){n.push(t)}));var r=this;!function i(h){CWPageManager.pages[h].getTextContent().then(function(t){for(var e=t.items,a="",s=0;s<e.length;s++)" "!=e[s].str[e[s].str.length-1]&&s<e.length-1&&e[s].transform[5]!=e[s+1].transform[5]?a+=e[s].str+" ":a+=e[s].str;r.pageContents.push(a),n[h](h),h+1<CWPageManager.pages.length&&i(h+1)})}(0)}},handleEvent:function(t){null!==this.state&&"findagain"===t.type||(this.dirtyMatch=!0),0<CwZ("#cw-searchTab").length&&0<CwZ("#cw-searchTab").find("ul").length&&CwZ("#cw-searchTab").find("ul").html(""),this.state=t.detail,this.updateUIState(FindStates.FIND_PENDING),this.extractText(),clearTimeout(this.findTimeout),"find"===t.type?this.findTimeout=setTimeout(this.nextMatch.bind(this),1e3):this.nextMatch()},updatePage:function(t){var e=CWPageManager.pages[t];this.selected.pageIdx===t&&CWPageManager.currentPage!=t+1&&CWPageManager.moveToPage(t+1,0,!1),e.textLayer&&e.textLayer.updateMatches()},nextMatch:function(){CWPageManager.pages;var t=this.state.findPrevious,i=CWPageManager.pages.length;if(this.active=!0,this.dirtyMatch){this.dirtyMatch=!1,this.selected.pageIdx=this.selected.matchIdx=-1,this.offset.pageIdx=t?i-1:0,this.offset.matchIdx=null,this.hadMatch=!1,this.resumeCallback=null,this.resumePageIdx=null,this.pageMatches=[],this.matchCount=0;for(var h=this,e=0;e<i;e++)this.updatePage(e),e in this.pendingFindMatches||(this.pendingFindMatches[e]=!0,this.extractTextPromises[e].then(function(t){delete h.pendingFindMatches[t],h.calcFindMatch(t);var e="";if(t==i-1&&0<PDFFindController.matchCount){var a="1 of "+PDFFindController.matchCount;CWUtils.log(a),e=a}else{var s=CwZ(".cw-searchBar > input").val();s&&(e="0 of 0")}t==i-1&&(CwZ(".cw-searchBar").find("span.searchCount").text(e),"0 of 0"===e?CwZ(".cw-searchBar").find("span.searchCount").addClass("no-match"):CwZ(".cw-searchBar").find("span.searchCount").removeClass("no-match"))}))}if(""!==this.state.query){if(!this.resumePageIdx){var a=this.offset;if(null!==a.matchIdx){var s=this.pageMatches[a.pageIdx].length;if(!t&&a.matchIdx+1<s||t&&0<a.matchIdx)return this.hadMatch=!0,a.matchIdx=t?a.matchIdx-1:a.matchIdx+1,this.updateMatch(!0),void this.showCurrMatchNumb(t);this.advanceOffsetPage(t)}this.nextPageMatch()}}else this.updateUIState(FindStates.FIND_FOUND)},showCurrMatchNumb:function(t){if(0!=PDFFindController.matchCount){var e,a=this.offset,s=null!=a.matchIdx?a.matchIdx:0,i=0,h=t&&null==a.matchIdx;if(0<a.pageIdx)for(var n=0;n<a.pageIdx;n++)i+=this.pageMatches[n].length;e=i+(h?this.pageMatches[a.pageIdx].length-1:s),e%=PDFFindController.matchCount;var r=e+1+" of "+PDFFindController.matchCount;if(CWUtils.log(r),0<PDFFindController.matchCount)CwZ(".cw-searchBar").find("span.searchCount").text(r),CwZ(".cw-searchBar").find("span.searchCount").removeClass("no-match");else{var c=CwZ(".cw-searchBar > input").val();c&&(CwZ(".cw-searchBar").find("span.searchCount").text("0 of 0"),CwZ(".cw-searchBar").find("span.searchCount").addClass("no-match"))}}},matchesReady:function(t){var e=this.offset,a=t.length,s=this.state.findPrevious;return a?(this.hadMatch=!0,e.matchIdx=s?a-1:0,this.updateMatch(!0),!0):(this.advanceOffsetPage(s),!(!e.wrapped||(e.matchIdx=null,this.hadMatch))&&(this.updateMatch(!1),!0))},nextPageMatch:function(){null!==this.resumePageIdx&&console.error("There can only be one pending page.");do{var t=this.offset.pageIdx,e=this.pageMatches[t];if(!e){this.resumePageIdx=t;break}}while(!this.matchesReady(e))},advanceOffsetPage:function(t){var e=this.offset,a=this.extractTextPromises.length;e.pageIdx=t?e.pageIdx-1:e.pageIdx+1,e.matchIdx=null,(e.pageIdx>=a||e.pageIdx<0)&&(e.pageIdx=t?a-1:0,e.wrapped=!0),this.showCurrMatchNumb(t)},updateMatch:function(t){var e=FindStates.FIND_NOTFOUND,a=this.offset.wrapped;if(this.offset.wrapped=!1,t){var s=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx,this.selected.matchIdx=this.offset.matchIdx,e=a?FindStates.FIND_WRAPPED:FindStates.FIND_FOUND,-1!==s&&s!==this.selected.pageIdx&&this.updatePage(s)}this.updateUIState(e,this.state.findPrevious),-1!==this.selected.pageIdx&&this.updatePage(this.selected.pageIdx,!0)},updateUIState:function(t,e){}},FindStates={FIND_FOUND:0,FIND_NOTFOUND:1,FIND_WRAPPED:2,FIND_PENDING:3};